create table t1(c1 integer not null,c2 integer not null, key (c1))
ENGINE=InnoDB STATS_PERSISTENT=1;
create view v1 as select * from t1 where c1 in (0,1);
insert t1 select 0,seq from seq_1_to_500;
insert t1 select 1,seq from seq_1_to_100;
insert t1 select 2,seq from seq_1_to_50;
insert t1 select 3,seq from seq_1_to_20;
analyze table t1;
Table	Op	Msg_type	Msg_text
test.t1	analyze	status	Engine-independent statistics collected
test.t1	analyze	status	OK
#
# Delete with limit (quick select - range acces)
#
start transaction;
delete from t1 where (select count(*) from t1 b where b.c1=t1.c1) = 500 limit 1;
affected rows: 1
delete from t1 where (select count(*) from t1 b where b.c1=t1.c1) = 500 limit 1;
affected rows: 0
select count(*) from v1 where c1=0;
count(*)
499
rollback;
#
# Delete
#
start transaction;
delete from t1 where (select count(*) from t1 b where b.c1=t1.c1) = 500 ;
affected rows: 500
rollback;
#
# Delete with exists
#
start transaction;
select count(*) from v1 where c1=2;
count(*)
0
delete from t1 where c1=2 and exists(select 'x' from t1 b where b.c2<10);
affected rows: 50
delete from t1 where c1=2 and exists(select 'x' from t1 b where b.c2<10);
affected rows: 0
select count(*) from v1 where c1=2;
count(*)
0
rollback;
#
# Delete through a view with limit (range access)
#
start transaction;
explain delete from v1 where (select count(*) from t1 b where b.c1=v1.c1) = 500 limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	c1	c1	4	NULL	600	Using index condition; Using where
2	DEPENDENT SUBQUERY	b	ref	c1	c1	4	test.t1.c1	167	Using index
delete from v1 where (select count(*) from t1 b where b.c1=v1.c1) = 500 limit 1;
affected rows: 1
delete from v1 where (select count(*) from t1 b where b.c1=v1.c1) = 500 limit 1;
affected rows: 0
select count(*) from v1 where c1=0;
count(*)
499
rollback;
#
# Delete through a view (ALL access)
#
start transaction;
explain delete from v1 where (select count(*) from t1 b where b.c1=v1.c1) = 500;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	c1	c1	4	NULL	#	Using index condition; Using where
2	DEPENDENT SUBQUERY	b	ref	c1	c1	4	test.t1.c1	#	Using index
delete from v1 where (select count(*) from t1 b where b.c1=v1.c1) = 500 ;
affected rows: 500
select count(*) from v1 where c1=0;
count(*)
0
rollback;
#
# Delete failed due to trigger
#
create trigger trg after delete on t1 for each row
begin
declare c int;
begin
if old.c1 = 1 then
select count(*) into c from t1 where c1!=old.c1;
SIGNAL SQLSTATE '45000' set table_name=c;
end if;
end;
end;
/
start transaction;
delete from t1 where c1=1 and (select count(*) from t1 b where b.c1=t1.c1) > 0 order by c2 asc limit 10;
ERROR 45000: Unhandled user-defined exception condition
rollback;
start transaction;
delete from t1 where (select count(*) from t1 b where b.c1=t1.c1) > 0 order by c1 desc limit 100;
ERROR 45000: Unhandled user-defined exception condition
select c1,count(*) from t1 group by c1;
c1	count(*)
0	500
1	100
2	50
3	20
rollback;
drop trigger trg;
#
# Delete through a view with returning
#
start transaction;
delete from t1 where (select count(*) from t1 b where b.c1=t1.c1) = 500 order by c2 asc limit 10 returning c1,c2;
c1	c2
0	1
0	2
0	3
0	4
0	5
0	6
0	7
0	8
0	9
0	10
rollback;
start transaction;
delete from t1 where (select count(*) from t1 b where b.c1=t1.c1) = 500 order by c2 desc limit 10 returning c1,c2;
c1	c2
0	491
0	492
0	493
0	494
0	495
0	496
0	497
0	498
0	499
0	500
rollback;
drop view v1;
drop table t1;
#
# Delete from table with more than 150000 rows
#
create table t1(c1 integer not null,c2 integer not null, key (c1));
insert t1 select 0,seq from seq_1_to_128000;
insert t1 select 1,seq from seq_1_to_25600;
select count(*) from t1;
count(*)
153600
# with a lot of memory for sort_buffer_size
set session sort_buffer_size = 1024000;
delete from t1 where c1=0 and exists(select 'x' from t1 b where b.c1<10);
affected rows: 128000
# with little memory for sort_buffer_size
insert t1 select 0,seq from seq_1_to_128000;
set session sort_buffer_size = 1024;
delete from t1 where c1=0 and exists(select 'x' from t1 b where b.c1<10);
affected rows: 128000
drop table t1;
#
# MDEV-17954: multi-table DELETE with the same source and target
#
create table t1 (c1 int, c2 int, c3 int);
insert into t1 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,4,7), (2,5,8);
#
# Single-table DELETE with the same source and target
# handled as multi-table DELETE
#
explain delete from t1
where c2 in (select distinct a.c2 from t1 a where t1.c1=a.c1 and a.c2 < 3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
delete from t1
where c2 in (select distinct a.c2 from t1 a where t1.c1=a.c1 and a.c2 < 3);
select * from t1;
c1	c2	c3
1	3	3
2	3	6
2	4	7
2	5	8
delete from t1;
insert into t1 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,4,7), (2,5,8);
prepare stmt from "delete from t1
where c2 in (select distinct a.c2 from t1 a where t1.c1=a.c1 and a.c2 < 3)";
execute stmt;
select * from t1;
c1	c2	c3
1	3	3
2	3	6
2	4	7
2	5	8
delete from t1;
insert into t1 values
(2,2,5), (2,3,6), (2,4,7), (2,5,8);
execute stmt;
select * from t1;
c1	c2	c3
2	3	6
2	4	7
2	5	8
deallocate prepare stmt;
delete from t1;
insert into t1 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,4,7), (2,5,8);
#
# Multi-table DELETE with the same source and target
#
create table t2 (c1 int, c2 int, c3 int);
insert into t2 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,5,8);
explain delete from t1 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t2	ALL	NULL	NULL	NULL	NULL	7	
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1;
select * from t1;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	4	7
delete from t1;
insert into t1 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,4,7), (2,5,8);
prepare stmt from "delete from t1 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1";
execute stmt;
select * from t1;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	4	7
delete from t1;
insert into t1 values
(2,2,5), (2,3,6), (2,4,7), (2,5,8);
execute stmt;
select * from t1;
c1	c2	c3
2	4	7
deallocate prepare stmt;
explain delete from t1 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	system	NULL	NULL	NULL	NULL	1	
1	SIMPLE	t2	ALL	NULL	NULL	NULL	NULL	7	Using where
delete from t1 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1;
select * from t1;
c1	c2	c3
2	4	7
delete from t1;
insert into t1 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,4,7), (2,5,8);
prepare stmt from "delete from t1 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1";
execute stmt;
select * from t1;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	4	7
delete from t1;
insert into t1 values
(2,2,5), (2,3,6), (2,4,7), (2,5,8);
execute stmt;
select * from t1;
c1	c2	c3
2	4	7
deallocate prepare stmt;
delete from t1;
insert into t1 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,4,7), (2,5,8);
explain delete from t1,t2 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1 and t2.c1 > 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t2	ALL	NULL	NULL	NULL	NULL	7	Using where
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1,t2 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1 and t2.c1 > 1;
select * from t1;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	4	7
select * from t2;
c1	c2	c3
1	1	1
1	2	2
1	3	3
delete from t1;
insert into t1 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,4,7), (2,5,8);
delete from t2;
insert into t2 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5), (2,3,6), (2,5,8);
prepare stmt from "delete from t1,t2 using t1,t2
where t1.c2 = t2.c2 and t1.c1 > 1 and t2.c1 > 1";
execute stmt;
select * from t1;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	4	7
select * from t2;
c1	c2	c3
1	1	1
1	2	2
1	3	3
delete from t1;
insert into t1 values
(1,2,2), (1,3,3), (2,2,5), (2,3,6), (2,4,7), (2,5,8);
delete from t2;
insert into t2 values
(1,1,1), (1,2,2), (1,3,3), (2,1,4), (2,2,5);
execute stmt;
select * from t1;
c1	c2	c3
1	2	2
1	3	3
2	3	6
2	4	7
2	5	8
select * from t2;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
deallocate prepare stmt;
drop table t1,t2;
#
# End of 10.10 tests
#
set @save_default_engine= @@default_storage_engine;
set default_storage_engine=InnoDB;
create table t1 (c1 integer, c2 integer, c3 integer);
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,1,4);
insert into t1(c1,c2,c3) values (2,2,5);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
create view v1 as select * from t1 where c2=2;
Test without any index
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.00	100.00	16.67	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.88	100.00	25.81	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	7.00	100.00	14.29	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	1.00	100.00	100.00	Using where; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	7.50	100.00	13.33	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
Test with an index
create index t1_c2 on t1 (c2,c1);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	Using where; Using index
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	3.67	100.00	18.18	Using where; Using index
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	4	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	8	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	8	4.00	100.00	100.00	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	10	test.t1.c2,test.t1.c3	1	Using index; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	Using index; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	7.00	100.00	14.29	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	1.00	100.00	100.00	Using index; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	index_subquery	t1_c2	t1_c2	5	func	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	1	Using index
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	1	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	8	Using where
3	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	1	Using index
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
3	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	1	1.00	100.00	100.00	Using index
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
Test with a primary key
drop index t1_c2 on t1;
alter table t1 add primary key (c3);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using index
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.33	100.00	15.38	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.38	100.00	29.63	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c1	1	Using where; End temporary
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	Using where; End temporary
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	1.00	100.00	100.00	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	1.00	100.00	100.00	Using where; End temporary
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	index	NULL	PRIMARY	4	NULL	1	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	PRIMARY	PRIMARY	4	NULL	5	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	3.50	100.00	28.57	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	1.00	100.00	100.00	
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
drop view v1;
drop table t1;
create temporary table t1 (c1 integer, c2 integer, c3 integer);
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,1,4);
insert into t1(c1,c2,c3) values (2,2,5);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
Test without any index
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.00	100.00	16.67	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	15	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	15	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	15	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	15	3.88	100.00	25.81	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	15	
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	15	Using where; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	15	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	15	Using where; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	15	7.00	100.00	14.29	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	15	1.00	100.00	100.00	Using where; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	22	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	22	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
Test with an index
create index t1_c2 on t1 (c2,c1);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	Using where; Using index
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	3.67	100.00	18.18	Using where; Using index
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	4	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	4	Using index
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	8	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	4	Using index
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	8	4.00	100.00	100.00	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	4	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	15	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	10	test.t1.c2,test.t1.c3	4	Using index; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	15	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	4	Using index; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	15	7.00	100.00	14.29	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	4	1.00	100.00	100.00	Using index; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	22	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	index_subquery	t1_c2	t1_c2	5	func	4	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
Test with a primary key
drop index t1_c2 on t1;
alter table t1 add primary key (c3);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using index
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.33	100.00	15.38	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	12	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	12	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	12	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	12	3.38	100.00	29.63	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	12	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c1	1	Using where; End temporary
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	12	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	Using where; End temporary
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	12	1.00	100.00	100.00	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	1.00	100.00	100.00	Using where; End temporary
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	index	NULL	PRIMARY	4	NULL	1	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
drop table t1;
#
# Test on dynamic columns (blob)
#
create table assets (
item_name varchar(32) primary key, -- A common attribute for all items
dynamic_cols  blob  -- Dynamic columns will be stored here
);
INSERT INTO assets VALUES ('MariaDB T-shirt', COLUMN_CREATE('color', 'blue', 'size', 'XL'));
INSERT INTO assets VALUES ('Thinkpad Laptop', COLUMN_CREATE('color', 'black', 'price', 500));
INSERT INTO assets VALUES ('Fridge', COLUMN_CREATE('color', 'white', 'warranty', '5 years'));
INSERT INTO assets VALUES ('Microwave', COLUMN_CREATE('warranty', '3 years'));
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	white
MariaDB T-shirt	blue
Microwave	NULL
Thinkpad Laptop	black
UPDATE assets SET dynamic_cols=COLUMN_DELETE(dynamic_cols, 'color') WHERE item_name='Fridge';
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
Microwave	NULL
Thinkpad Laptop	black
DELETE FROM assets
WHERE item_name in (select b.item_name
from assets b
where COLUMN_GET(b.dynamic_cols, 'color' as char) ='black');
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
Microwave	NULL
DELETE FROM assets WHERE item_name='Microwave';
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
drop table assets ;
#
# Test on fulltext columns
#
CREATE TABLE ft2(copy TEXT,FULLTEXT(copy));
INSERT INTO ft2(copy) VALUES
('MySQL vs MariaDB database'),
('Oracle vs MariaDB database'),
('PostgreSQL vs MariaDB database'),
('MariaDB overview'),
('Foreign keys'),
('Primary keys'),
('Indexes'),
('Transactions'),
('Triggers');
SELECT * FROM ft2 WHERE MATCH(copy) AGAINST('database');
copy
MySQL vs MariaDB database
Oracle vs MariaDB database
PostgreSQL vs MariaDB database
DELETE FROM ft2 WHERE  MATCH(copy) AGAINST('database');
SELECT * FROM ft2 WHERE MATCH(copy) AGAINST('database');
copy
drop table ft2;
set default_storage_engine=Aria;
create table t1 (c1 integer, c2 integer, c3 integer);
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,1,4);
insert into t1(c1,c2,c3) values (2,2,5);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
create view v1 as select * from t1 where c2=2;
Test without any index
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.33	100.00	15.38	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.38	100.00	29.63	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	3.00	100.00	33.33	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
Test with an index
create index t1_c2 on t1 (c2,c1);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	Using where; Using index
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	3.67	100.00	18.18	Using where; Using index
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	5	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	5	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	5	4.00	100.00	100.00	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	10	test.t1.c2,test.t1.c3	2	Using index; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	Using index; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	5.00	100.00	20.00	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	1.00	100.00	100.00	Using index; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	index_subquery	t1_c2	t1_c2	5	func	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	2	Using index
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	2	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ref	t1_c2	t1_c2	5	const	2	Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	10	NULL	2	Using index condition; Using where
3	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	2	Using index
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	10	NULL	2	2.00	25.00	100.00	Using index condition; Using where
3	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	2	1.00	100.00	100.00	Using index
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
Test with a primary key
drop index t1_c2 on t1;
alter table t1 add primary key (c3);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using index
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.67	100.00	18.18	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.88	100.00	25.81	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c1	1	Using where; End temporary
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	Using where; End temporary
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	4.00	100.00	100.00	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	1.00	100.00	25.00	Using where; End temporary
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	index	NULL	PRIMARY	4	NULL	1	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	PRIMARY	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	1.50	100.00	66.67	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	1.00	100.00	100.00	
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
drop view v1;
drop table t1;
create temporary table t1 (c1 integer, c2 integer, c3 integer);
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,1,4);
insert into t1(c1,c2,c3) values (2,2,5);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
Test without any index
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.33	100.00	15.38	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.38	100.00	29.63	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
Test with an index
create index t1_c2 on t1 (c2,c1);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	Using where; Using index
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	3.67	100.00	18.18	Using where; Using index
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	5	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	5	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	5	4.00	100.00	100.00	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	10	test.t1.c2,test.t1.c3	2	Using index; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	Using index; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	1.00	100.00	100.00	Using index; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	index_subquery	t1_c2	t1_c2	5	func	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
Test with a primary key
drop index t1_c2 on t1;
alter table t1 add primary key (c3);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using index
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.33	100.00	15.38	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.38	100.00	29.63	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c1	1	Using where; End temporary
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	Using where; End temporary
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	100.00	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	1.00	100.00	50.00	Using where; End temporary
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	index	NULL	PRIMARY	4	NULL	1	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
drop table t1;
#
# Test on dynamic columns (blob)
#
create table assets (
item_name varchar(32) primary key, -- A common attribute for all items
dynamic_cols  blob  -- Dynamic columns will be stored here
);
INSERT INTO assets VALUES ('MariaDB T-shirt', COLUMN_CREATE('color', 'blue', 'size', 'XL'));
INSERT INTO assets VALUES ('Thinkpad Laptop', COLUMN_CREATE('color', 'black', 'price', 500));
INSERT INTO assets VALUES ('Fridge', COLUMN_CREATE('color', 'white', 'warranty', '5 years'));
INSERT INTO assets VALUES ('Microwave', COLUMN_CREATE('warranty', '3 years'));
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	white
MariaDB T-shirt	blue
Microwave	NULL
Thinkpad Laptop	black
UPDATE assets SET dynamic_cols=COLUMN_DELETE(dynamic_cols, 'color') WHERE item_name='Fridge';
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
Microwave	NULL
Thinkpad Laptop	black
DELETE FROM assets
WHERE item_name in (select b.item_name
from assets b
where COLUMN_GET(b.dynamic_cols, 'color' as char) ='black');
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
Microwave	NULL
DELETE FROM assets WHERE item_name='Microwave';
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
drop table assets ;
#
# Test on fulltext columns
#
CREATE TABLE ft2(copy TEXT,FULLTEXT(copy));
INSERT INTO ft2(copy) VALUES
('MySQL vs MariaDB database'),
('Oracle vs MariaDB database'),
('PostgreSQL vs MariaDB database'),
('MariaDB overview'),
('Foreign keys'),
('Primary keys'),
('Indexes'),
('Transactions'),
('Triggers');
SELECT * FROM ft2 WHERE MATCH(copy) AGAINST('database');
copy
MySQL vs MariaDB database
Oracle vs MariaDB database
PostgreSQL vs MariaDB database
DELETE FROM ft2 WHERE  MATCH(copy) AGAINST('database');
SELECT * FROM ft2 WHERE MATCH(copy) AGAINST('database');
copy
drop table ft2;
set default_storage_engine=MyISAM;
create table t1 (c1 integer, c2 integer, c3 integer);
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,1,4);
insert into t1(c1,c2,c3) values (2,2,5);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
create view v1 as select * from t1 where c2=2;
Test without any index
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.33	100.00	15.38	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.62	100.00	27.59	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	3.00	100.00	33.33	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
Test with an index
create index t1_c2 on t1 (c2,c1);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	Using where; Using index
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	3.67	100.00	18.18	Using where; Using index
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	4	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	4	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	4	4.00	100.00	100.00	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	10	test.t1.c2,test.t1.c3	2	Using index; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	Using index; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	5.00	100.00	20.00	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	1.00	100.00	100.00	Using index; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	index_subquery	t1_c2	t1_c2	5	func	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	2	Using index
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	2	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ref	t1_c2	t1_c2	5	const	2	Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	10	NULL	2	Using index condition; Using where
3	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	2	Using index
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	10	NULL	2	2.00	25.00	100.00	Using index condition; Using where
3	DEPENDENT SUBQUERY	t1	ref	t1_c2	t1_c2	10	const,test.t1.c1	2	1.00	100.00	100.00	Using index
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
Test with a primary key
drop index t1_c2 on t1;
alter table t1 add primary key (c3);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using index
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.67	100.00	18.18	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.12	100.00	24.24	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c1	1	Using where; End temporary
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	Using where; End temporary
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	4.00	100.00	100.00	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	1.00	100.00	25.00	Using where; End temporary
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	index	NULL	PRIMARY	4	NULL	1	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
Delete using a view in subquery
#
explain delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 
where t1.c2 in ( select max(a.c2)
from v1 a
where a.c1 = t1.c1) ;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	12.50	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete throw a view
#
explain delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	PRIMARY	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from v1
where v1.c1 in (select max(a.c1)
from t1 a
where a.c2 = v1.c2) 
and c3 > 3;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
#
# Delete through  a view and using the view in subquery
#
explain delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	
analyze delete from v1 
where v1.c2 in (select max(a.c2)
from t1 a
where a.c3 = v1.c3) 
and c1 < 10 
and exists (select 'X'
                 from v1 a
where a.c1 = v1.c1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
3	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	8	1.50	100.00	66.67	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	1.00	100.00	100.00	
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (2,2,5);
drop view v1;
drop table t1;
create temporary table t1 (c1 integer, c2 integer, c3 integer);
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,1,4);
insert into t1(c1,c2,c3) values (2,2,5);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
Test without any index
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.33	100.00	15.38	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.62	100.00	27.59	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
Test with an index
create index t1_c2 on t1 (c2,c1);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	Using where; Using index
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	index	NULL	t1_c2	10	NULL	8	3.67	100.00	18.18	Using where; Using index
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	4	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	4	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	Using index
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	range	t1_c2	t1_c2	5	NULL	4	4.00	100.00	100.00	Using index condition; Using where
2	DEPENDENT SUBQUERY	a	ref	t1_c2	t1_c2	5	test.t1.c2	1	1.00	100.00	100.00	Using index
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_c2	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	10	test.t1.c2,test.t1.c3	2	Using index; FirstMatch(t1)
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	Using index; FirstMatch(t1)
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	50.00	Using where
1	PRIMARY	a	ref	t1_c2	t1_c2	5	test.t1.c1	1	1.00	100.00	100.00	Using index; FirstMatch(t1)
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where; Using filesort
2	DEPENDENT SUBQUERY	a	index_subquery	t1_c2	t1_c2	5	func	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
Test with a primary key
drop index t1_c2 on t1;
alter table t1 add primary key (c3);
#
# Delete with value from subquery on the same table, no search clause. ALL access
#
explain delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using index
delete from t1
where c1=(select a.c3
from t1 a
where a.c3 = t1.c3);
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with search clause on the same table
#
explain delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1
where c1 <2
and exists (select 'X'
                 from t1 a
where a.c1 = t1.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	25.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	4.00	100.00	16.67	Using where
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete via RANGE or INDEX access if an index or a primary key exists
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3;
affected rows: 4
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete with order by
#
explain delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	Using where
analyze delete from t1 where exists (select 'X' from t1 a where a.c2 = t1.c2) and c2 >= 3 order by c2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	8	8.00	100.00	50.00	Using where
2	DEPENDENT SUBQUERY	a	ALL	NULL	NULL	NULL	NULL	8	3.62	100.00	27.59	Using where
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
2	1	4
2	2	5
insert into t1(c1,c2,c3) values (1,3,3);
insert into t1(c1,c2,c3) values (2,3,6);
insert into t1(c1,c2,c3) values (2,4,7);
insert into t1(c1,c2,c3) values (2,5,8);
#
# Delete using the index or primary key (c3)
#
explain delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c1	1	Using where; End temporary
delete from t1 where c3 in (select distinct a.c1 from t1 a where t1.c2=a.c2);
affected rows: 2
select * from t1 order by c3;
c1	c2	c3
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
insert into t1(c1,c2,c3) values (1,2,2);
#
# Delete with a limit - can be delete
#
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	Using where; End temporary
analyze delete from t1 
where c1 in (select a.c2
from t1 a
where a.c2 = t1.c3)
limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	a	ALL	NULL	NULL	NULL	NULL	8	2.00	100.00	100.00	Using where; Start temporary
1	PRIMARY	t1	eq_ref	PRIMARY	PRIMARY	4	test.a.c2	1	1.00	100.00	50.00	Using where; End temporary
select * from t1 order by c3;
c1	c2	c3
1	2	2
1	3	3
2	1	4
2	2	5
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (1,1,1);
#
# Delete with a limit and an order by
#
select * from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc;
c1	c2	c3
2	2	5
1	1	1
explain delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	index	NULL	PRIMARY	4	NULL	1	Using where
2	DEPENDENT SUBQUERY	a	eq_ref	PRIMARY	PRIMARY	4	test.t1.c3	1	Using where
delete from t1 
where c1 in (select a.c2
from t1 a
where a.c3 = t1.c3)
order by c3 desc limit 1;
affected rows: 1
select * from t1 order by c3;
c1	c2	c3
1	1	1
1	2	2
1	3	3
2	1	4
2	3	6
2	4	7
2	5	8
insert into t1(c1,c2,c3) values (2,2,5);
drop table t1;
#
# Test on dynamic columns (blob)
#
create table assets (
item_name varchar(32) primary key, -- A common attribute for all items
dynamic_cols  blob  -- Dynamic columns will be stored here
);
INSERT INTO assets VALUES ('MariaDB T-shirt', COLUMN_CREATE('color', 'blue', 'size', 'XL'));
INSERT INTO assets VALUES ('Thinkpad Laptop', COLUMN_CREATE('color', 'black', 'price', 500));
INSERT INTO assets VALUES ('Fridge', COLUMN_CREATE('color', 'white', 'warranty', '5 years'));
INSERT INTO assets VALUES ('Microwave', COLUMN_CREATE('warranty', '3 years'));
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	white
MariaDB T-shirt	blue
Microwave	NULL
Thinkpad Laptop	black
UPDATE assets SET dynamic_cols=COLUMN_DELETE(dynamic_cols, 'color') WHERE item_name='Fridge';
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
Microwave	NULL
Thinkpad Laptop	black
DELETE FROM assets
WHERE item_name in (select b.item_name
from assets b
where COLUMN_GET(b.dynamic_cols, 'color' as char) ='black');
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
Microwave	NULL
DELETE FROM assets WHERE item_name='Microwave';
SELECT item_name, COLUMN_GET(dynamic_cols, 'color' as char) AS color FROM assets ORDER BY item_name;
item_name	color
Fridge	NULL
MariaDB T-shirt	blue
drop table assets ;
#
# Test on fulltext columns
#
CREATE TABLE ft2(copy TEXT,FULLTEXT(copy));
INSERT INTO ft2(copy) VALUES
('MySQL vs MariaDB database'),
('Oracle vs MariaDB database'),
('PostgreSQL vs MariaDB database'),
('MariaDB overview'),
('Foreign keys'),
('Primary keys'),
('Indexes'),
('Transactions'),
('Triggers');
SELECT * FROM ft2 WHERE MATCH(copy) AGAINST('database');
copy
MySQL vs MariaDB database
Oracle vs MariaDB database
PostgreSQL vs MariaDB database
DELETE FROM ft2 WHERE  MATCH(copy) AGAINST('database');
SELECT * FROM ft2 WHERE MATCH(copy) AGAINST('database');
copy
drop table ft2;
set @@default_storage_engine= @save_default_engine;
#
# End of 10.11 tests
#
