include/master-slave.inc
[connection master]
connection slave;
include/stop_slave.inc
SET @old_parallel_mode= @@GLOBAL.slave_parallel_mode;
SET @old_parallel_threads= @@GLOBAL.slave_parallel_threads;
SET GLOBAL slave_parallel_mode= optimistic;
SET GLOBAL slave_parallel_threads= 4;
CHANGE MASTER to master_use_gtid= slave_pos;
connection master;
ALTER TABLE mysql.gtid_slave_pos ENGINE=InnoDB;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1, 1);
INSERT INTO t1 VALUES (2, 2);
INSERT INTO t1 VALUES (3, 3);
INSERT INTO t1 VALUES (4, 4);
INSERT INTO t1 VALUES (5, 5);
INSERT INTO t1 VALUES (6, 6);
INSERT INTO t1 VALUES (7, 7);
SET SESSION gtid_seq_no= 100;
ALTER TABLE t1 ADD COLUMN (c INT);
SET STATEMENT gtid_domain_id= 1 FOR CREATE INDEX c_idx ON t1 (c);
UPDATE t1 SET c=a+2*b WHERE a BETWEEN 3 and 5;
INSERT INTO t1 VALUES (8, 8, 100);
INSERT INTO t1 VALUES (9, 9, 200);
INSERT INTO t1 VALUES (10, 10, 200);
SELECT * FROM t1 ORDER BY a;
a	b	c
1	1	NULL
2	2	NULL
3	3	9
4	4	12
5	5	15
6	6	NULL
7	7	NULL
8	8	100
9	9	200
10	10	200
include/save_master_gtid.inc
connection slave;
SET @old_dbug= @@GLOBAL.debug_dbug;
SET GLOBAL debug_dbug= "+d,rpl_parallel_delay_gtid_0_x_100_start";
include/start_slave.inc
include/sync_with_master_gtid.inc
SET GLOBAL debug_dbug= @old_dbug;
SELECT * FROM t1 ORDER BY a;
a	b	c
1	1	NULL
2	2	NULL
3	3	9
4	4	12
5	5	15
6	6	NULL
7	7	NULL
8	8	100
9	9	200
10	10	200
connection slave;
include/stop_slave.inc
SET GLOBAL slave_parallel_mode= @old_parallel_mode;
SET GLOBAL slave_parallel_threads= @old_parallel_threads;
include/start_slave.inc
connection master;
DROP TABLE t1;
include/rpl_end.inc
