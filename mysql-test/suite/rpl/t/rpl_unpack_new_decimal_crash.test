################################################################################
# MDEV-33049 Assertion `marked_for_write_or_computed()' failed in bool
#            Field_new_decimal::store_value(const my_decimal*, int*)
#
# In FULL_NODUP mode, the before image has all fields and the after image has
# only updated fields. Crash happened when slave was unpacking a row event
# if the new decimal field is null in the before image.
################################################################################
--source include/have_binlog_format_row.inc
--source include/master-slave.inc

SET binlog_row_image = FULL_NODUP;

CREATE TABLE t1(c1 INT NOT NULL PRIMARY KEY, c2 varchar(10) DEFAULT NULL,
                c3 decimal(12,4) DEFAULT NULL);
INSERT INTO t1(c1) VALUES (1);
--source include/save_master_pos.inc
--let $datadir= `SELECT @@datadir`

# It will generate a row event that c3 is only in before image and it is null.
UPDATE t1 SET c2 = 'c2';

# the UPDATE will crash the slave without this fix.
--source include/rpl_sync.inc

FLUSH BINARY LOGS;
UPDATE t1 SET c2 = "c2_new";

# BINLOG statement is same to applier, it should work well.
--exec $MYSQL_BINLOG --start-position=$_master_pos $datadir$_master_file > $MYSQLTEST_VARDIR/tmp/binlog.sql
--exec $MYSQL < $MYSQLTEST_VARDIR/tmp/binlog.sql

# c2's value should be "c2"
SELECT * FROM t1;

--remove_file $MYSQLTEST_VARDIR/tmp/binlog.sql
DROP TABLE t1;
SET binlog_row_image = default;
--source include/rpl_end.inc
