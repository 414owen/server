set @old_binlog_gtid_pos_cache= @@global.binlog_gtid_pos_cache;
set @old_binlog_gtid_pos_cache_sparse= @@global.binlog_gtid_pos_cache_sparse;
set @@global.binlog_gtid_pos_cache= 0;
reset master;
set @@global.binlog_gtid_pos_cache= 2;
reset master;
select @@gtid_binlog_pos;
@@gtid_binlog_pos

create table t1 (a int primary key, b int) engine=innodb;
select @@gtid_binlog_pos;
@@gtid_binlog_pos
0-1-1
insert t1 values (1,1),(3,3),(5,5),(7,7);
select @@gtid_binlog_pos;
@@gtid_binlog_pos
0-1-2
set @@session.gtid_domain_id= 222;
create table t2 (m int);
select @@gtid_binlog_pos;
@@gtid_binlog_pos
0-1-2,222-1-1
insert t2 values (1);
select @@gtid_binlog_pos;
@@gtid_binlog_pos
0-1-2,222-1-2
update t1 set b=50 where b=5;
set @@session.gtid_domain_id= 333;
select @@gtid_binlog_pos;
@@gtid_binlog_pos
0-1-2,222-1-3
update t1 set b=10 where a=5;
flush binary logs;
select @@gtid_binlog_pos;
@@gtid_binlog_pos
0-1-2,222-1-3,333-1-1
update t1 set b=20 where a= 5;
set @@global.binlog_gtid_pos_cache= 0;
select binlog_gtid_pos('master-bin.000001', 3);
ERROR HY000: File './master-bin.000001' not found (Errcode: 2 "No such file or directory")
set @@global.binlog_gtid_pos_cache= 1;
select binlog_gtid_pos('master-bin.000001', 3);
binlog_gtid_pos('master-bin.000001', 3)

select binlog_gtid_pos('master-bin.000001', 255);
binlog_gtid_pos('master-bin.000001', 255)
NULL
pos_1

pos_2

pos_3

pos_4

pos_5

pos_6
0-1-1
pos_7
0-1-1
pos_8
0-1-2
pos_9
0-1-2
pos_10
0-1-2
pos_11
0-1-2
pos_12
0-1-2
pos_13
0-1-2,222-1-1
pos_14
0-1-2,222-1-1
pos_15
0-1-2,222-1-2
pos_16
0-1-2,222-1-2
pos_17
0-1-2,222-1-2
pos_18
0-1-2,222-1-2
pos_19
0-1-2,222-1-2
pos_20
0-1-2,222-1-3
pos_21
0-1-2,222-1-3
pos_22
0-1-2,222-1-3
pos_23
0-1-2,222-1-3
pos_24
0-1-2,222-1-3
pos_25
0-1-2,222-1-3,333-1-1
pos_26
0-1-2,222-1-3,333-1-1
pos_27
0-1-2,222-1-3,333-1-1
pos_28
0-1-2,222-1-3,333-1-1
select binlog_gtid_pos('master-bin.000002', 4);
binlog_gtid_pos('master-bin.000002', 4)
0-1-2,222-1-3,333-1-1
select binlog_gtid_pos('master-bin.000002', 256);
binlog_gtid_pos('master-bin.000002', 256)
0-1-2,222-1-3,333-1-1
select binlog_gtid_pos('master-bin.000002', 375);
binlog_gtid_pos('master-bin.000002', 375)
NULL
# Check binlog_hash rotation
select binlog_gtid_pos('master-bin.000002', 4);
binlog_gtid_pos('master-bin.000002', 4)
0-1-2,222-1-3,333-1-1
set @@global.binlog_gtid_pos_cache= 0;
select binlog_gtid_pos('master-bin.000002', 4);
ERROR HY000: File './master-bin.000002' not found (Errcode: 2 "No such file or directory")
set @@global.binlog_gtid_pos_cache= 1;
select binlog_gtid_pos('master-bin.000002', 4);
binlog_gtid_pos('master-bin.000002', 4)
0-1-2,222-1-3,333-1-1
flush binary logs;
select binlog_gtid_pos('master-bin.000002', 4);
ERROR HY000: File './master-bin.000002' not found (Errcode: 2 "No such file or directory")
select binlog_gtid_pos('master-bin.000002', 4);
binlog_gtid_pos('master-bin.000002', 4)
0-1-2,222-1-3,333-1-1
select binlog_gtid_pos('master-bin.000002', 256);
binlog_gtid_pos('master-bin.000002', 256)
0-1-2,222-1-3,333-1-1
select binlog_gtid_pos('master-bin.000002', 375);
binlog_gtid_pos('master-bin.000002', 375)
NULL
set @@global.binlog_gtid_pos_cache= 12;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
flush binary logs;
master-bin.000001
master-bin.000002
master-bin.000003
master-bin.000004
master-bin.000005
master-bin.000006
master-bin.000007
master-bin.000008
master-bin.000009
master-bin.000010
master-bin.000011
master-bin.000012
master-bin.000013
master-bin.000014
master-bin.000015
master-bin.000016
master-bin.000017
master-bin.000018
master-bin.000019
master-bin.index
select binlog_gtid_pos('master-bin.000007', 4);
ERROR HY000: File './master-bin.000007' not found (Errcode: 2 "No such file or directory")
select binlog_gtid_pos('master-bin.000008', 4);
binlog_gtid_pos('master-bin.000008', 4)
0-1-2,222-1-3,333-1-2
set @@global.binlog_gtid_pos_cache= 3;
flush binary logs;
# Check row format, server_id
insert t2 values (2);
set @@session.gtid_domain_id= 12;
set @@session.server_id= 2;
update t2 set m= 2;
set @@session.gtid_domain_id= 22;
insert t2 values (4);
set @@session.gtid_domain_id= 33;
set @@session.server_id= 3;
update t2 set m= 3;
set @@session.gtid_domain_id= 44;
delete from t2;
flush binary logs;
pos_1
0-1-2,222-1-3,333-1-2
pos_2
0-1-2,222-1-3,333-1-2
pos_3
0-1-2,222-1-3,333-1-2
pos_4
0-1-2,222-1-3,333-1-2
pos_5
0-1-2,222-1-3,333-1-2
pos_6
0-1-2,222-1-3,333-1-3
pos_7
0-1-2,222-1-3,333-1-3
pos_8
0-1-2,222-1-3,333-1-3
pos_9
0-1-2,222-1-3,333-1-3
pos_10
0-1-2,222-1-3,333-1-3
pos_11
0-1-2,12-2-1,222-1-3,333-1-3
pos_12
0-1-2,12-2-1,222-1-3,333-1-3
pos_13
0-1-2,12-2-1,222-1-3,333-1-3
pos_14
0-1-2,12-2-1,222-1-3,333-1-3
pos_15
0-1-2,12-2-1,222-1-3,333-1-3
pos_16
0-1-2,12-2-1,22-2-1,222-1-3,333-1-3
pos_17
0-1-2,12-2-1,22-2-1,222-1-3,333-1-3
pos_18
0-1-2,12-2-1,22-2-1,222-1-3,333-1-3
pos_19
0-1-2,12-2-1,22-2-1,222-1-3,333-1-3
pos_20
0-1-2,12-2-1,22-2-1,222-1-3,333-1-3
pos_21
0-1-2,12-2-1,22-2-1,33-3-1,222-1-3,333-1-3
pos_22
0-1-2,12-2-1,22-2-1,33-3-1,222-1-3,333-1-3
pos_23
0-1-2,12-2-1,22-2-1,33-3-1,222-1-3,333-1-3
pos_24
0-1-2,12-2-1,22-2-1,33-3-1,222-1-3,333-1-3
pos_25
0-1-2,12-2-1,22-2-1,33-3-1,222-1-3,333-1-3
pos_26
0-1-2,12-2-1,22-2-1,33-3-1,44-3-1,222-1-3,333-1-3
pos_27
0-1-2,12-2-1,22-2-1,33-3-1,44-3-1,222-1-3,333-1-3
pos_28
0-1-2,12-2-1,22-2-1,33-3-1,44-3-1,222-1-3,333-1-3
pos_29
0-1-2,12-2-1,22-2-1,33-3-1,44-3-1,222-1-3,333-1-3
drop table t1,t2;
set @@global.binlog_gtid_pos_cache= @old_binlog_gtid_pos_cache;
set @@global.binlog_gtid_pos_cache_sparse= @old_binlog_gtid_pos_cache_sparse;
